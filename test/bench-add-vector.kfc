;; -*- scheme -*-
;; Vector sum

(module
  (fn main ()
      ; for some reason we're running out of RAM when iters > 1
      (let iters 1)
      
      (for (i 1 101)
           (let len (* (var i) 100000))
           (let ttime 0)
           (for (k 0 (var iters))
                ;; TODO: make these vectors of length len
                (let X (make-vector (var len)))
                (let Y (make-vector (var len)))
                (for (j 0 (var len))
                     (vector-set! (var X) (var j) 1)
                     (vector-set! (var Y) (var j) 1))
                (let start (time))
                (let Sum (kernel ((x (var X)) (y (var Y)))
                           (+ (var x) (var y))))
                (let stop (time))
                
                (for (m 0 (var len))
                  (assert (= (vector-ref Sum (var m)) 2)))
                
                (set! (var ttime) (+ (var ttime) (- (var stop) (var start)))))                     
           (print (var len) (var ttime)))
      (return 0)))
